#include "Doubletap.h"
#include "..\..\Menu\config.h"

Doubletap g_Doubletap;

static float TicksToTime(int ticks) {
	
	return g_pGlobalVars->intervalPerTick * (float)(ticks);
}

void Doubletap::DoubleTap()
{
	static bool did_shift_before = false;
	static int double_tapped = 0;
	static int prev_shift_ticks = 0;
	static bool reset = false;

	m_tick_to_shift = 0;


	if (CanDT())	// is choked commands okay
	{
		prev_shift_ticks = 0;

		// Can I shift 15 ticks forward and fire the weapon...
		auto can_shift_shot = CanFireWithExploit(c_config::get().ticks_to_shift);

		// Can I shift 1 tick forward and fire the weapon?
		auto can_shot = CanFireWithExploit(fabsf(-1 - prev_shift_ticks));

		// If I can Shift 15 ticks forward and shoot or..
		// If I can't shift one tick forward, and I haven't shifted before...
		if (can_shift_shot || (!can_shot && !did_shift_before))
		{
			prev_shift_ticks = c_config::get().ticks_to_shift;
			double_tapped = 0;
		}
		// If I can't shift 15 ticks forward and shoot
		// I can still shift forward, or I have shifted before
		else {
			double_tapped++;
			prev_shift_ticks = 0;
		}

		// If I can shift 15 ticks and shoot, or 
		// I can't shift one tick forward, and I haven't shifted before

		// AKA if I did shift before and haven't finished shifting OR
		// I haven't shifted yet?
		if (prev_shift_ticks > 0)
		{
			// Can I shift the previously shifted ticks
			if (CanFireWithExploit(prev_shift_ticks))
			{
				if (Globals::pCmd->buttons & IN_ATTACK)
				{
					//std::string str = "say Dting for shift ticks: " + std::to_string(prev_shift_ticks);
					//g_pEngine->ExecuteClientCmd(str.c_str());
					m_tick_to_shift = prev_shift_ticks;
					reset = true;
				}
				else {
					auto* weap = Globals::LocalPlayer->GetActiveWeapon();
					if ((!(Globals::pCmd->buttons & IN_ATTACK)) && reset
						&& fabsf(weap->GetLastShotTime() - TicksToTime(Globals::LocalPlayer->GetTickBase())) > 0.5f) {
						m_charged = false;
						m_tick_to_recharge = c_config::get().ticks_to_shift + 1;
						reset = false;
					}
				}
			}
		}
		did_shift_before = prev_shift_ticks != 0;
	}
}

bool Doubletap::CanFireWeapon(float curtime)
{
	if (!Globals::LocalPlayer)
		return false;

	if (!Globals::LocalPlayer->IsAlive())
		return false;

	C_BaseCombatWeapon* ActiveWeap = Globals::LocalPlayer->GetActiveWeapon();
	if (!ActiveWeap)
		return false;

	if (curtime >= ActiveWeap->GetNextPrimaryAttack())
		return true;

	return false;
}

bool Doubletap::CanFireWithExploit(int m_iShiftedTick)
{
	// curtime before shift
	float curtime = TicksToTime(Globals::LocalPlayer->GetTickBase() - m_iShiftedTick);
	return CanFireWeapon(curtime);
}

bool Doubletap::CanDT()
{
	return Globals::LocalPlayer->IsAlive();
}

void Doubletap::start()
{
	//DT recharge
	if (Globals::LocalPlayer && Globals::LocalPlayer->IsAlive() && m_tick_to_recharge > 0 && !m_charged) {
		if (Globals::bSendPacket)
			m_tick_to_recharge--;
		if (m_tick_to_recharge == 0) {
			m_charged = true;
		}
		
		Globals::pCmd->tick_count = INT_MAX;

	}

	/*if (m_tick_to_shift > 0)
	{
		*G::pSendPacket = true;
		fakelag->PredictedVal = true;
	}*/
}

void Doubletap::end()
{
	if(&c_config::get().doubletap && c_config::get().ticks_to_shift > 0)
		DoubleTap();
}